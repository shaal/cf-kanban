generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?

  /// AMENDMENT-001: Workspace path where Claude Code operates
  /// This is the local filesystem folder for the project's codebase
  workspacePath String?

  /// GAP-3.1.1: Project template reference for pre-configured swarm settings
  templateId  String?
  template    ProjectTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  settings    Json            @default("{}")
  isArchived  Boolean         @default(false)
  tickets     Ticket[]
  members     ProjectMember[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([workspacePath])
  @@index([templateId])
}

/// GAP-3.1.1: Pre-configured swarm setups for common use cases
/// Templates define agent configurations and swarm topologies for different project types
model ProjectTemplate {
  id          String    @id @default(cuid())

  /// Template identifier (e.g., 'web-app', 'security-audit')
  slug        String    @unique

  /// Display name for the template
  name        String

  /// Description of what this template is best suited for
  description String

  /// Category for grouping templates (e.g., 'development', 'security', 'documentation')
  category    String

  /// Icon identifier for UI display
  icon        String    @default("bot")

  /// Swarm configuration as JSON
  /// Contains: agents[], topology, maxAgents, hiveMind, options
  swarmConfig Json

  /// Whether this is a built-in system template
  isSystem    Boolean   @default(true)

  /// Whether this template is active and selectable
  isActive    Boolean   @default(true)

  /// Display order for sorting in UI
  sortOrder   Int       @default(0)

  /// Projects using this template
  projects    Project[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([category])
  @@index([isActive, sortOrder])
}

model Ticket {
  id          String         @id @default(cuid())
  title       String
  description String?
  status      TicketStatus   @default(BACKLOG)
  priority    Priority       @default(MEDIUM)
  labels      String[]
  complexity  Int?
  position    Int            @default(0)

  projectId   String
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  /// TASK-097: User assignment
  assignedToId String?
  assignedTo   User?          @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  history     TicketHistory[]
  questions   TicketQuestion[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([assignedToId])
}

model TicketHistory {
  id         String       @id @default(cuid())
  ticketId   String
  ticket     Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  fromStatus TicketStatus
  toStatus   TicketStatus
  reason     String?
  triggeredBy String      @default("system")
  createdAt  DateTime     @default(now())
}

enum TicketStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  NEEDS_FEEDBACK
  READY_TO_RESUME
  REVIEW
  DONE
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

/// Question types for agent-user feedback loop
enum QuestionType {
  TEXT        /// Free-form text input
  CHOICE      /// Single choice from options
  MULTISELECT /// Multiple choices from options
  CONFIRM     /// Yes/No confirmation
  CODE        /// Code input with syntax highlighting
}

/// TASK-055: Questions asked by agents during ticket execution
/// This is the core model for the swim-lane feedback loop
model TicketQuestion {
  id           String       @id @default(cuid())
  ticketId     String
  ticket       Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  /// Agent that asked the question
  agentId      String

  /// The question text
  question     String

  /// Type of answer expected
  type         QuestionType @default(TEXT)

  /// Options for CHOICE/MULTISELECT types
  options      String[]

  /// Whether an answer is required before resuming
  required     Boolean      @default(true)

  /// Additional context about why this question is being asked
  context      String?

  /// For CODE type: the programming language
  codeLanguage String?

  /// Default value suggestion
  defaultValue String?

  /// The user's answer (null if not yet answered)
  answer       String?

  /// Whether the question has been answered
  answered     Boolean      @default(false)

  /// When the question was asked
  createdAt    DateTime     @default(now())

  /// When the question was answered
  answeredAt   DateTime?

  @@index([ticketId])
  @@index([ticketId, answered])
}

/// TASK-062: Execution checkpoint for progress restoration
/// Stores snapshots of execution state for recovery on failure
model ExecutionCheckpoint {
  id        String   @id @default(cuid())
  ticketId  String

  /// Type of checkpoint: auto (periodic), manual (user-triggered), stage (on stage complete)
  type      String   @default("auto")

  /// Version number for ordering checkpoints
  version   Int      @default(0)

  /// Serialized progress state including stages, logs, and context
  data      Json

  /// When the checkpoint was created
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([ticketId, createdAt])
}

/// TASK-100-104: User roles for access control
enum UserRole {
  OWNER    /// Full access, can delete organization
  ADMIN    /// Admin access, can manage users and projects
  MEMBER   /// Standard member, can edit projects
  VIEWER   /// Read-only access
}

/// TASK-096/097: User model for authentication and authorization
/// Compatible with Auth.js for OAuth providers
model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String?
  avatarUrl      String?
  image          String?         /// Auth.js compatibility field
  role           UserRole        @default(MEMBER)
  isActive       Boolean         @default(true)

  /// External auth provider ID (for Clerk or other providers)
  externalId     String?         @unique

  /// Activity tracking
  lastLoginAt    DateTime?
  loginCount     Int             @default(0)

  /// Invitation tracking
  invitedBy      String?
  invitedAt      DateTime?
  acceptedAt     DateTime?

  /// Auth.js required fields
  emailVerified  DateTime?

  /// Auth.js relations
  accounts       Account[]
  sessions       Session[]

  /// Project memberships
  projectMembers ProjectMember[]

  /// Tickets assigned to this user
  assignedTickets Ticket[]       @relation("AssignedTo")

  /// Audit logs created by this user
  auditLogs      AuditLog[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([email])
  @@index([role])
  @@index([externalId])
}

/// TASK-096: Auth.js Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// TASK-096: Auth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// TASK-096: Auth.js Verification Token for email verification
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// TASK-101: Project membership for per-project roles
model ProjectMember {
  id        String      @id @default(cuid())

  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Project-specific role (can override global role for this project)
  role      UserRole    @default(MEMBER)

  /// When user joined this project
  joinedAt  DateTime    @default(now())

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

/// TASK-104: Audit log action categories
enum AuditAction {
  /// User actions
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_INVITED
  USER_ROLE_CHANGED
  USER_LOGIN
  USER_LOGOUT

  /// Project actions
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_DELETED
  PROJECT_ARCHIVED
  PROJECT_MEMBER_ADDED
  PROJECT_MEMBER_REMOVED

  /// Ticket actions
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_DELETED
  TICKET_STATUS_CHANGED

  /// System settings actions
  SETTINGS_UPDATED
  INTEGRATION_CONFIGURED

  /// Security actions
  PERMISSION_DENIED
  SENSITIVE_DATA_ACCESSED
}

/// TASK-104: Audit log for tracking admin and sensitive actions
model AuditLog {
  id          String      @id @default(cuid())

  /// The user who performed the action
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Action category
  action      AuditAction

  /// Entity type affected (User, Project, Ticket, etc.)
  entityType  String

  /// ID of the affected entity
  entityId    String?

  /// Detailed description of the action
  description String

  /// Additional metadata (old values, new values, context)
  metadata    Json        @default("{}")

  /// IP address of the request
  ipAddress   String?

  /// User agent string
  userAgent   String?

  /// Whether this was a sensitive operation
  isSensitive Boolean     @default(false)

  /// When the action occurred
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([isSensitive, createdAt])
}

/// TASK-103: System settings for global configuration
model SystemSettings {
  id          String   @id @default(cuid())

  /// Setting key (e.g., 'default.project.settings', 'claude-flow.api-key')
  key         String   @unique

  /// Setting value as JSON
  value       Json

  /// Description of what this setting controls
  description String?

  /// Category for grouping settings
  category    String   @default("general")

  /// Whether this is a sensitive setting (should be masked in UI)
  isSensitive Boolean  @default(false)

  /// Last modified by user ID
  updatedBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
}
