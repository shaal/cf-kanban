generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?

  /// AMENDMENT-001: Workspace path where Claude Code operates
  /// This is the local filesystem folder for the project's codebase
  workspacePath String?

  /// GAP-3.1.1: Project template reference for pre-configured swarm settings
  templateId  String?
  template    ProjectTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  settings    Json            @default("{}")
  isArchived  Boolean         @default(false)
  tickets     Ticket[]
  members     ProjectMember[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([workspacePath])
  @@index([templateId])
}

/// GAP-3.1.1: Pre-configured swarm setups for common use cases
/// Templates define agent configurations and swarm topologies for different project types
model ProjectTemplate {
  id          String    @id @default(cuid())

  /// Template identifier (e.g., 'web-app', 'security-audit')
  slug        String    @unique

  /// Display name for the template
  name        String

  /// Description of what this template is best suited for
  description String

  /// Category for grouping templates (e.g., 'development', 'security', 'documentation')
  category    String

  /// Icon identifier for UI display
  icon        String    @default("bot")

  /// Swarm configuration as JSON
  /// Contains: agents[], topology, maxAgents, hiveMind, options
  swarmConfig Json

  /// Whether this is a built-in system template
  isSystem    Boolean   @default(true)

  /// Whether this template is active and selectable
  isActive    Boolean   @default(true)

  /// Display order for sorting in UI
  sortOrder   Int       @default(0)

  /// Projects using this template
  projects    Project[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([category])
  @@index([isActive, sortOrder])
}

model Ticket {
  id          String         @id @default(cuid())
  title       String
  description String?
  status      TicketStatus   @default(BACKLOG)
  priority    Priority       @default(MEDIUM)
  labels      String[]
  complexity  Int?
  position    Int            @default(0)

  projectId   String
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  /// TASK-097: User assignment
  assignedToId String?
  assignedTo   User?          @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  /// GAP-3.2.4: Ticket dependency IDs - tickets that must be completed before this one can progress
  dependencyIds String[]

  history     TicketHistory[]
  questions   TicketQuestion[]

  /// GAP-3.2.5: File attachments for tickets
  attachments TicketAttachment[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([assignedToId])
}

/// GAP-3.2.5: File attachments for tickets
/// Stores metadata about files attached to tickets (mockups, specs, references)
model TicketAttachment {
  id          String   @id @default(cuid())

  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  /// Original filename as uploaded by user
  filename    String

  /// Stored filename (unique, includes timestamp/id)
  storedName  String

  /// MIME type of the file
  mimeType    String

  /// File size in bytes
  size        Int

  /// Relative path from uploads directory
  path        String

  /// Optional description or notes about the attachment
  description String?

  /// User who uploaded the file (optional for now)
  uploadedBy  String?

  createdAt   DateTime @default(now())

  @@index([ticketId])
}

model TicketHistory {
  id         String       @id @default(cuid())
  ticketId   String
  ticket     Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  fromStatus TicketStatus
  toStatus   TicketStatus
  reason     String?
  triggeredBy String      @default("system")
  createdAt  DateTime     @default(now())
}

enum TicketStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  NEEDS_FEEDBACK
  READY_TO_RESUME
  REVIEW
  DONE
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

/// Question types for agent-user feedback loop
enum QuestionType {
  TEXT        /// Free-form text input
  CHOICE      /// Single choice from options
  MULTISELECT /// Multiple choices from options
  CONFIRM     /// Yes/No confirmation
  CODE        /// Code input with syntax highlighting
}

/// TASK-055: Questions asked by agents during ticket execution
/// This is the core model for the swim-lane feedback loop
model TicketQuestion {
  id           String       @id @default(cuid())
  ticketId     String
  ticket       Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  /// Agent that asked the question
  agentId      String

  /// The question text
  question     String

  /// Type of answer expected
  type         QuestionType @default(TEXT)

  /// Options for CHOICE/MULTISELECT types
  options      String[]

  /// Whether an answer is required before resuming
  required     Boolean      @default(true)

  /// Additional context about why this question is being asked
  context      String?

  /// For CODE type: the programming language
  codeLanguage String?

  /// Default value suggestion
  defaultValue String?

  /// The user's answer (null if not yet answered)
  answer       String?

  /// Whether the question has been answered
  answered     Boolean      @default(false)

  /// When the question was asked
  createdAt    DateTime     @default(now())

  /// When the question was answered
  answeredAt   DateTime?

  @@index([ticketId])
  @@index([ticketId, answered])
}

/// TASK-062: Execution checkpoint for progress restoration
/// Stores snapshots of execution state for recovery on failure
model ExecutionCheckpoint {
  id        String   @id @default(cuid())
  ticketId  String

  /// Type of checkpoint: auto (periodic), manual (user-triggered), stage (on stage complete)
  type      String   @default("auto")

  /// Version number for ordering checkpoints
  version   Int      @default(0)

  /// Serialized progress state including stages, logs, and context
  data      Json

  /// When the checkpoint was created
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([ticketId, createdAt])
}

/// TASK-100-104: User roles for access control
enum UserRole {
  OWNER    /// Full access, can delete organization
  ADMIN    /// Admin access, can manage users and projects
  MEMBER   /// Standard member, can edit projects
  VIEWER   /// Read-only access
}

/// TASK-096/097: User model for authentication and authorization
/// Compatible with Auth.js for OAuth providers
model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String?
  avatarUrl      String?
  image          String?         /// Auth.js compatibility field
  role           UserRole        @default(MEMBER)
  isActive       Boolean         @default(true)

  /// External auth provider ID (for Clerk or other providers)
  externalId     String?         @unique

  /// Activity tracking
  lastLoginAt    DateTime?
  loginCount     Int             @default(0)

  /// Invitation tracking
  invitedBy      String?
  invitedAt      DateTime?
  acceptedAt     DateTime?

  /// Auth.js required fields
  emailVerified  DateTime?

  /// Auth.js relations
  accounts       Account[]
  sessions       Session[]

  /// Project memberships
  projectMembers ProjectMember[]

  /// Tickets assigned to this user
  assignedTickets Ticket[]       @relation("AssignedTo")

  /// Audit logs created by this user
  auditLogs      AuditLog[]

  /// GAP-3.5.1: Notification preferences
  notificationPreferences NotificationPreference[]

  /// GAP-3.5.1: In-app notifications
  notifications           Notification[]

  /// GAP-3.5.1: Email digest settings
  emailDigestSettings     EmailDigestSettings?

  /// GAP-3.5.1: Webhook configurations
  webhooks                WebhookConfig[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([email])
  @@index([role])
  @@index([externalId])
}

/// TASK-096: Auth.js Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// TASK-096: Auth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// TASK-096: Auth.js Verification Token for email verification
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// TASK-101: Project membership for per-project roles
model ProjectMember {
  id        String      @id @default(cuid())

  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Project-specific role (can override global role for this project)
  role      UserRole    @default(MEMBER)

  /// When user joined this project
  joinedAt  DateTime    @default(now())

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

/// TASK-104: Audit log action categories
enum AuditAction {
  /// User actions
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_INVITED
  USER_ROLE_CHANGED
  USER_LOGIN
  USER_LOGOUT

  /// Project actions
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_DELETED
  PROJECT_ARCHIVED
  PROJECT_MEMBER_ADDED
  PROJECT_MEMBER_REMOVED

  /// Ticket actions
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_DELETED
  TICKET_STATUS_CHANGED

  /// System settings actions
  SETTINGS_UPDATED
  INTEGRATION_CONFIGURED

  /// Security actions
  PERMISSION_DENIED
  SENSITIVE_DATA_ACCESSED
}

/// TASK-104: Audit log for tracking admin and sensitive actions
model AuditLog {
  id          String      @id @default(cuid())

  /// The user who performed the action
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Action category
  action      AuditAction

  /// Entity type affected (User, Project, Ticket, etc.)
  entityType  String

  /// ID of the affected entity
  entityId    String?

  /// Detailed description of the action
  description String

  /// Additional metadata (old values, new values, context)
  metadata    Json        @default("{}")

  /// IP address of the request
  ipAddress   String?

  /// User agent string
  userAgent   String?

  /// Whether this was a sensitive operation
  isSensitive Boolean     @default(false)

  /// When the action occurred
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([isSensitive, createdAt])
}

/// TASK-103: System settings for global configuration
model SystemSettings {
  id          String   @id @default(cuid())

  /// Setting key (e.g., 'default.project.settings', 'claude-flow.api-key')
  key         String   @unique

  /// Setting value as JSON
  value       Json

  /// Description of what this setting controls
  description String?

  /// Category for grouping settings
  category    String   @default("general")

  /// Whether this is a sensitive setting (should be masked in UI)
  isSensitive Boolean  @default(false)

  /// Last modified by user ID
  updatedBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
}

/// GAP-3.5.1: Notification event types for categorizing notifications
enum NotificationEventType {
  /// Ticket events
  TICKET_ASSIGNED
  TICKET_STATUS_CHANGED
  TICKET_MENTIONED
  TICKET_COMPLETED
  TICKET_COMMENT

  /// Project events
  PROJECT_MEMBER_ADDED
  PROJECT_MEMBER_REMOVED
  PROJECT_ARCHIVED

  /// Agent events
  AGENT_QUESTION
  AGENT_COMPLETED
  AGENT_FAILED
  AGENT_STARTED

  /// System events
  SYSTEM_ALERT
  SYSTEM_ANNOUNCEMENT
  HEALTH_DEGRADED
  HEALTH_RECOVERED
}

/// GAP-3.5.1: Notification delivery channel types
enum NotificationChannel {
  IN_APP        /// In-app notification center
  EMAIL         /// Email notifications
  EMAIL_DIGEST  /// Batched email digest
  WEBHOOK       /// Webhook delivery
}

/// GAP-3.5.1: Notification preference per user
/// Controls which notifications a user receives and how they receive them
model NotificationPreference {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Event type this preference applies to
  eventType       NotificationEventType

  /// Delivery channels enabled for this event type
  channels        NotificationChannel[]

  /// Whether this notification type is enabled at all
  enabled         Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, eventType])
  @@index([userId])
}

/// GAP-3.5.1: In-app notification for users
/// Stores notifications to be displayed in the notification center
model Notification {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Event type for categorization
  eventType       NotificationEventType

  /// Notification title
  title           String

  /// Notification message/body
  message         String

  /// Whether the notification has been read
  read            Boolean  @default(false)

  /// When the notification was read
  readAt          DateTime?

  /// Related entity type (Ticket, Project, etc.)
  entityType      String?

  /// Related entity ID for navigation
  entityId        String?

  /// Additional metadata (context, actor info, etc.)
  metadata        Json     @default("{}")

  /// When the notification was created
  createdAt       DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

/// GAP-3.5.1: Email digest settings per user
/// Controls email digest frequency and preferences
model EmailDigestSettings {
  id              String   @id @default(cuid())

  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Whether email digests are enabled
  enabled         Boolean  @default(false)

  /// Digest frequency: daily, weekly
  frequency       String   @default("daily")

  /// Preferred time to receive digest (hour in UTC, 0-23)
  preferredHour   Int      @default(9)

  /// For weekly digest: preferred day (0=Sunday, 6=Saturday)
  preferredDay    Int      @default(1)

  /// Last time a digest was sent
  lastSentAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

/// GAP-3.5.1: Webhook configuration for notification delivery
/// Allows users to configure external webhooks for notifications
model WebhookConfig {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Webhook name for identification
  name            String

  /// Webhook URL to send notifications to
  url             String

  /// Secret for HMAC signature verification
  secret          String?

  /// Event types this webhook should receive
  eventTypes      NotificationEventType[]

  /// Whether the webhook is active
  enabled         Boolean  @default(true)

  /// Last successful delivery timestamp
  lastSuccessAt   DateTime?

  /// Number of consecutive failures
  failureCount    Int      @default(0)

  /// Whether webhook is paused due to failures
  isPaused        Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  /// Delivery logs
  deliveryLogs    WebhookDeliveryLog[]

  @@index([userId])
  @@index([enabled, isPaused])
}

/// GAP-3.5.1: Webhook delivery log for auditing and debugging
model WebhookDeliveryLog {
  id              String   @id @default(cuid())

  webhookId       String
  webhook         WebhookConfig @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  /// Event type that triggered the delivery
  eventType       NotificationEventType

  /// HTTP response status code (null if request failed)
  statusCode      Int?

  /// Whether delivery was successful
  success         Boolean

  /// Error message if delivery failed
  errorMessage    String?

  /// Response body (truncated)
  responseBody    String?

  /// Request duration in milliseconds
  durationMs      Int?

  /// Payload that was sent
  payload         Json

  createdAt       DateTime @default(now())

  @@index([webhookId])
  @@index([createdAt])
}
